

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4. Object-Oriented Programming &#8212; Foundations of Programming Languages Second Edition</title>
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. Standard ML" href="functional.html" />
    <link rel="prev" title="3. Assembly Language" href="assembly.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="functional.html" title="5. Standard ML"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="assembly.html" title="3. Assembly Language"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Foundations of Programming Languages Second Edition</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4. Object-Oriented Programming</a><ul>
<li><a class="reference internal" href="#the-java-environment">4.1. The Java Environment</a></li>
<li><a class="reference internal" href="#the-c-environment">4.2. The C++ Environment</a><ul>
<li><a class="reference internal" href="#example-4-1">4.2.1. Example 4.1</a></li>
<li><a class="reference internal" href="#the-macro-processor">4.2.2. The Macro Processor</a></li>
<li><a class="reference internal" href="#the-make-tool">4.2.3. The Make Tool</a></li>
</ul>
</li>
<li><a class="reference internal" href="#namespaces">4.3. Namespaces</a><ul>
<li><a class="reference internal" href="#example-4-2">4.3.1. Example 4.2</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dynamic-linking">4.4. Dynamic Linking</a></li>
<li><a class="reference internal" href="#defining-the-main-function">4.5. Defining the Main Function</a></li>
<li><a class="reference internal" href="#i-o-streams">4.6. I/O Streams</a></li>
<li><a class="reference internal" href="#garbage-collection">4.7. Garbage Collection</a></li>
<li><a class="reference internal" href="#threading">4.8. Threading</a></li>
<li><a class="reference internal" href="#the-pytoken-class">4.9. The PyToken Class</a></li>
<li><a class="reference internal" href="#inheritance-and-polymorphism">4.10. Inheritance and Polymorphism</a></li>
<li><a class="reference internal" href="#interfaces-and-adapters">4.11. Interfaces and Adapters</a></li>
<li><a class="reference internal" href="#functions-as-values">4.12. Functions as Values</a></li>
<li><a class="reference internal" href="#anonymous-inner-classes">4.13. Anonymous Inner Classes</a></li>
<li><a class="reference internal" href="#type-casting-and-generics">4.14. Type Casting and Generics</a></li>
<li><a class="reference internal" href="#auto-boxing-and-unboxing">4.15. Auto-Boxing and Unboxing</a></li>
<li><a class="reference internal" href="#exception-handling-in-java-and-c">4.16. Exception Handling in Java and C++</a></li>
<li><a class="reference internal" href="#signals">4.17. Signals</a></li>
<li><a class="reference internal" href="#jcoco-in-depth">4.18. JCoCo In Depth</a></li>
<li><a class="reference internal" href="#the-scanner">4.19. The Scanner</a></li>
<li><a class="reference internal" href="#the-parser">4.20. The Parser</a></li>
<li><a class="reference internal" href="#the-assembler">4.21. The Assembler</a></li>
<li><a class="reference internal" href="#bytecode">4.22. ByteCode</a></li>
<li><a class="reference internal" href="#jcocos-class-and-interface-type-hierarchy">4.23. JCoCo’s Class and Interface Type Hierarchy</a></li>
<li><a class="reference internal" href="#code">4.24. Code</a></li>
<li><a class="reference internal" href="#functions">4.25. Functions</a></li>
<li><a class="reference internal" href="#classes">4.26. Classes</a></li>
<li><a class="reference internal" href="#methods">4.27. Methods</a></li>
<li><a class="reference internal" href="#jcoco-exceptions-and-tracebacks">4.28. JCoCo Exceptions and Tracebacks</a></li>
<li><a class="reference internal" href="#magic-methods">4.29. Magic Methods</a></li>
<li><a class="reference internal" href="#dictionaries">4.30. Dictionaries</a><ul>
<li><a class="reference internal" href="#two-new-classes">4.30.1. Two New Classes</a></li>
<li><a class="reference internal" href="#two-new-types">4.30.2. Two New Types</a></li>
<li><a class="reference internal" href="#two-new-instructions">4.30.3. Two New Instructions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#chapter-summary">4.31. Chapter Summary</a></li>
<li><a class="reference internal" href="#review-questions">4.32. Review Questions</a></li>
<li><a class="reference internal" href="#exercises">4.33. Exercises</a></li>
<li><a class="reference internal" href="#solutions-to-practice-problems">4.34. Solutions to Practice Problems</a><ul>
<li><a class="reference internal" href="#solution-to-practice-problem-4-1">4.34.1. Solution to Practice Problem 4.1</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-2">4.34.2. Solution to Practice Problem 4.2</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-3">4.34.3. Solution to Practice Problem 4.3</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-4">4.34.4. Solution to Practice Problem 4.4</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-5">4.34.5. Solution to Practice Problem 4.5</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-6">4.34.6. Solution to Practice Problem 4.6</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-7">4.34.7. Solution to Practice Problem 4.7</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-8">4.34.8. Solution to Practice Problem 4.8</a></li>
<li><a class="reference internal" href="#solution-to-practice-problem-4-9">4.34.9. Solution to Practice Problem 4.9</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="assembly.html"
                        title="previous chapter">3. Assembly Language</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="functional.html"
                        title="next chapter">5. Standard ML</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/oop.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="object-oriented-programming">
<h1>4. Object-Oriented Programming<a class="headerlink" href="#object-oriented-programming" title="Permalink to this headline">¶</a></h1>
<div class="figboxcenter docutils container">
<div class="figure">
<a class="reference internal image-reference" href="_images/CoCoStructure.png"><img alt="_images/CoCoStructure.png" src="_images/CoCoStructure.png" style="width: 3in;" /></a>
</div>
<p><strong>Fig. 4.1</strong> JCoCo</p>
</div>
<div class="figboxcenter docutils container">
<div class="figure">
<a class="reference internal image-reference" href="_images/cocooverview.png"><img alt="_images/cocooverview.png" src="_images/cocooverview.png" style="width: 5in;" /></a>
</div>
<p><strong>Fig. 4.2</strong> The JCoCo Virtual Machine</p>
</div>
<div class="section" id="the-java-environment">
<h2>4.1. The Java Environment<a class="headerlink" href="#the-java-environment" title="Permalink to this headline">¶</a></h2>
<div class="figbox docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorld</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span>
   <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello World&quot;</span><span class="o">);</span>
  <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.3</strong> Hello World</p>
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span> My Mac&gt; javac HelloWorld.java
 My Mac&gt; java HelloWorld
 Hello World
 My Mac&gt;
</pre></div>
</td></tr></table></div>
</div>
<div class="figboxcenter docutils container">
<div class="figure">
<a class="reference internal image-reference" href="_images/javastructure.png"><img alt="_images/javastructure.png" src="_images/javastructure.png" style="width: 5in;" /></a>
</div>
<p><strong>Fig. 4.4</strong> The Java Compiler and Virtual Machine</p>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.1</strong></p>
<p>Another program is written and compiled. Here is the error message from the compiler. What can you discern from the compile message? Why would this be important to Java?</p>
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span> test.java:1: error: class Test is public,
    should be declared in a file named Test.java
 public class Test {
        ^
 1 error
 My Mac&gt;
</pre></div>
</td></tr></table></div>
<p><a class="reference internal" href="#exercise4-1"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="the-c-environment">
<h2>4.2. The C++ Environment<a class="headerlink" href="#the-c-environment" title="Permalink to this headline">¶</a></h2>
<div class="section" id="example-4-1">
<h3>4.2.1. Example 4.1<a class="headerlink" href="#example-4-1" title="Permalink to this headline">¶</a></h3>
<div class="figboxcenter docutils container">
<div class="figure">
<img alt="_images/cppcompilation.png" src="_images/cppcompilation.png" />
</div>
<p><strong>Fig. 4.5</strong> C++ Compile</p>
</div>
<div class="figbox docutils container">
<blockquote>
<div><div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello World!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p><strong>Fig. 4.6</strong> hello.cpp</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>My Computer&gt; g++ hello.cpp
My Computer&gt; a.out
Hello World!
My Computer&gt;
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.7</strong> compiling hello.cpp</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>My Computer&gt; g++ -g -o hello hello.cpp
My Computer&gt; hello
Hello World!
My Computer&gt;
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.8</strong> Include Debug and Name</p>
</div>
</div>
<div class="section" id="the-macro-processor">
<h3>4.2.2. The Macro Processor<a class="headerlink" href="#the-macro-processor" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="the-make-tool">
<h3>4.2.3. The Make Tool<a class="headerlink" href="#the-make-tool" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PyObject.o: PyObject.cpp PyObect.h
  g++ -g -c -std=c++0x PyObject.cpp
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>coco: main.o PyObject.o PyInt.o PyType.o ....
  g++ -o coco -std=c++0x main.o PyObject.o PyInt.o PyType.o ....
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>./rebuild
./configure
make
</pre></div>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.2</strong></p>
<p>Using C++ there are no naming requirements for modules and classes like Java. So, when class A uses class Test both class A and class Test can be put into a  le by any name. Why is this OK for C++ programs, but not for Java programs?</p>
<p><a class="reference internal" href="#exercise4-2"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
</div>
<div class="section" id="namespaces">
<h2>4.3. Namespaces<a class="headerlink" href="#namespaces" title="Permalink to this headline">¶</a></h2>
<div class="section" id="example-4-2">
<h3>4.3.1. Example 4.2<a class="headerlink" href="#example-4-2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">iostream</span> <span class="kn">import</span> <span class="o">*</span> <span class="c1"># merges the namespace with the current module</span>
<span class="kn">import</span> <span class="nn">iostream</span> <span class="c1"># preserves the namespace while importing the module</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.iostream.cout</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello World!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.9</strong> Namespace std</p>
</div>
</div>
</div>
<div class="section" id="dynamic-linking">
<h2>4.4. Dynamic Linking<a class="headerlink" href="#dynamic-linking" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export CLASSPATH=./DBBrowser/lib/mysql-connector-java-5.1.17-bin.jar:.:$CLASSPATH
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.BufferedInputStream</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-the-main-function">
<h2>4.5. Defining the Main Function<a class="headerlink" href="#defining-the-main-function" title="Permalink to this headline">¶</a></h2>
<div class="exercise docutils container">
<p><strong>Practice 4.3</strong></p>
<p>Command-line arguments are typed in after the name of the program. For
instance if a program is called <em>grep</em> then you might provide
command-line arguments like this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>grep def *.py
</pre></div>
</div>
<p>Both C++ and Java programs can receive command-line arguments through
the main function. With C++ the number of command-line arguments is
passed as <em>argc</em> and the actual arguments are passed in the array of
strings (i.e. character arrays) in the parameter named <em>argv</em> as
declared in figure&nbsp;[namespacestd]. The variable <em>argc</em> is always at
least one for C++ programs but the length of the command-line arguments
String array in Java may be zero if no command-line arguments are
passed. Do you know why?</p>
<p><a class="reference internal" href="#exercise4-3"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="i-o-streams">
<h2>4.6. I/O Streams<a class="headerlink" href="#i-o-streams" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Hello World&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Hello World&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="garbage-collection">
<h2>4.7. Garbage Collection<a class="headerlink" href="#garbage-collection" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="threading">
<h2>4.8. Threading<a class="headerlink" href="#threading" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="the-pytoken-class">
<h2>4.9. The PyToken Class<a class="headerlink" href="#the-pytoken-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="n">tok</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">!=</span> <span class="n">TokenType</span><span class="o">.</span><span class="na">PYEOFTOKEN</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Excpected End Of File (EOF)&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">PyToken</span> <span class="n">t</span><span class="o">;</span>
<span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PyToken</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">lex</span><span class="o">,</span> <span class="n">line</span><span class="o">,</span> <span class="n">column</span><span class="o">);</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">jcoco</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PyToken</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">enum</span> <span class="n">TokenType</span> <span class="o">{</span>
        <span class="n">PYIDENTIFIERTOKEN</span><span class="o">,</span>
        <span class="n">PYINTEGERTOKEN</span><span class="o">,</span>
        <span class="n">PYFLOATTOKEN</span><span class="o">,</span>
        <span class="n">PYSTRINGTOKEN</span><span class="o">,</span>
        <span class="n">PYKEYWORDTOKEN</span><span class="o">,</span>
        <span class="n">PYCOLONTOKEN</span><span class="o">,</span>
        <span class="n">PYCOMMATOKEN</span><span class="o">,</span>
        <span class="n">PYSLASHTOKEN</span><span class="o">,</span>
        <span class="n">PYLEFTPARENTOKEN</span><span class="o">,</span>
        <span class="n">PYRIGHTPARENTOKEN</span><span class="o">,</span>
        <span class="n">PYEOFTOKEN</span><span class="o">,</span>
        <span class="n">PYBADTOKEN</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">lexeme</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">TokenType</span> <span class="n">type</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">line</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">col</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PyToken</span><span class="o">(</span><span class="n">TokenType</span> <span class="n">type</span><span class="o">,</span> <span class="n">String</span> <span class="n">lex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">line</span><span class="o">,</span> <span class="kt">int</span> <span class="n">col</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lexeme</span> <span class="o">=</span> <span class="n">lex</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">TokenType</span> <span class="nf">getType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLex</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">lexeme</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// See getCol and getLine in the full source code.</span>
<span class="o">}</span>
</pre></div>
</div>
<p><strong>Fig 4.10</strong> The PyToken class</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">PyToken</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">PyToken</span><span class="p">(</span><span class="kt">int</span> <span class="n">tokenType</span><span class="p">,</span> <span class="n">string</span> <span class="n">lex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">col</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">PyToken</span><span class="p">();</span>
    <span class="n">string</span> <span class="nf">getLex</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">int</span> <span class="nf">getType</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">int</span> <span class="nf">getCol</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">int</span> <span class="nf">getLine</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="k">private</span><span class="o">:</span>
    <span class="n">string</span> <span class="n">lexeme</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">tokenType</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">column</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYIDENTIFIERTOKEN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYINTEGERTOKEN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYFLOATTOKEN</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYSTRINGTOKEN</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYKEYWORDTOKEN</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYCOLONTOKEN</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYCOMMATOKEN</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYSLASHTOKEN</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYLEFTPARENTOKEN</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYRIGHTPARENTOKEN</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYEOFTOKEN</span> <span class="o">=</span> <span class="mi">98</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PYBADTOKEN</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Fig 4.11</strong> The C++ PyToken class declaration - PyToken.h</p>
</div>
<div class="figboxcenter docutils container">
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;PyToken.h&quot;</span><span class="cp"></span>
<span class="n">PyToken</span><span class="o">::</span><span class="n">PyToken</span><span class="p">(</span><span class="kt">int</span> <span class="n">tokenType</span><span class="p">,</span> <span class="n">string</span> <span class="n">lex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">col</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">lexeme</span> <span class="o">=</span> <span class="n">lex</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">tokenType</span> <span class="o">=</span> <span class="n">tokenType</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="n">col</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">PyToken</span><span class="o">::~</span><span class="n">PyToken</span><span class="p">()</span> <span class="p">{}</span>
<span class="kt">int</span> <span class="n">PyToken</span><span class="o">::</span><span class="n">getType</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">tokenType</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">string</span> <span class="n">PyToken</span><span class="o">::</span><span class="n">getLex</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">lexeme</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// getLine and getCol omitted.</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>Fig 4.12</strong> The C++ PyToken class declaration - PyToken.cpp</p>
</div>
</div>
<div class="section" id="inheritance-and-polymorphism">
<h2>4.10. Inheritance and Polymorphism<a class="headerlink" href="#inheritance-and-polymorphism" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef PYOBJECT_H_</span>
<span class="cp">#define PYOBJECT_H_</span>

<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unordered_map&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PyType</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PyObject</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">PyObject</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">PyObject</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="n">PyType</span><span class="o">*</span> <span class="nf">getType</span><span class="p">();</span>
   <span class="k">virtual</span> <span class="n">string</span> <span class="nf">toString</span><span class="p">();</span>
   <span class="n">PyObject</span><span class="o">*</span> <span class="nf">callMethod</span><span class="p">(</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span> <span class="n">args</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>
    <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="p">(</span><span class="n">PyObject</span><span class="o">::*</span><span class="p">)(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">dict</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">__type__</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">__hash__</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span> <span class="n">args</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">bool</span> <span class="n">verbose</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PYOBJECT_H_ */</span><span class="cp"></span>
</pre></div>
</div>
<p><strong>Fig 4.13</strong> The C++ PyObject header file - PyObject.h</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="o">*</span> <span class="n">PyObject</span><span class="o">::</span><span class="n">__str__</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ostringstream</span> <span class="n">msg</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;TypeError: expected 0 arguments, got &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">PyException</span><span class="p">(</span><span class="n">PYWRONGARGCOUNTEXCEPTION</span><span class="p">,</span><span class="n">msg</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">PyStr</span><span class="p">(</span><span class="n">toString</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fig 4.14</strong> The CoCo str magic method</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">string</span> <span class="n">PyInt</span><span class="o">::</span><span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fig 4.15</strong> The PyInt toString method</p>
</div>
<div class="figboxcenter docutils container">
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">string</span> <span class="n">PyList</span><span class="o">::</span><span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ostringstream</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;</span> <span class="n">args</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">callMethod</span><span class="p">(</span><span class="s">&quot;__repr__&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">args</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>Fig 4.16</strong> The PyList toString method</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">operator</span> <span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="interfaces-and-adapters">
<h2>4.11. Interfaces and Adapters<a class="headerlink" href="#interfaces-and-adapters" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<blockquote>
<div><div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">jcoco</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PyObject</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">str</span><span class="o">()</span> <span class="o">;</span>
    <span class="kd">public</span> <span class="n">PyType</span> <span class="nf">getType</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">PyObject</span> <span class="n">value</span><span class="o">)</span> <span class="o">;</span>
    <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">;</span>
    <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">callMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p><strong>Fig 4.17</strong> The PyObject interface</p>
</div>
<div class="figboxcenter docutils container">
<blockquote>
<div><div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kn">package</span> <span class="nn">jcoco</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">PyObjectAdapter</span> <span class="kd">implements</span> <span class="n">PyObject</span> <span class="o">{</span>
      <span class="kd">protected</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">dict</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;();</span>
      <span class="kd">protected</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">attrs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;();</span>
      <span class="kd">protected</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
      <span class="kd">protected</span> <span class="n">PyType</span><span class="o">.</span><span class="na">PyTypeId</span> <span class="n">type</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">PyObjectAdapter</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">PyType</span><span class="o">.</span><span class="na">PyTypeId</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">();</span>
          <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
          <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nf">PyObjectAdapter</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PyObject()&quot;</span><span class="o">;</span>
          <span class="n">type</span> <span class="o">=</span> <span class="n">PyType</span><span class="o">.</span><span class="na">PyTypeId</span><span class="o">.</span><span class="na">PyClassType</span><span class="o">;</span>
          <span class="n">PyObjectAdapter</span> <span class="n">self</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
          <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__str__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyBaseCallable</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                   <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYWRONGARGCOUNTEXCEPTION</span><span class="o">,</span>
                           <span class="s">&quot;TypeError: expected 0 argument, got &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                  <span class="o">}</span>

                  <span class="k">return</span> <span class="k">new</span> <span class="n">PyStr</span><span class="o">(</span><span class="n">self</span><span class="o">.</span><span class="na">str</span><span class="o">());</span>
              <span class="o">}</span>
          <span class="o">});</span>
         <span class="o">...</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="n">PyType</span> <span class="nf">getType</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">JCoCo</span><span class="o">.</span><span class="na">PyTypes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="n">String</span> <span class="nf">str</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">PyStr</span> <span class="n">s</span> <span class="o">=</span> <span class="o">(</span><span class="n">PyStr</span><span class="o">)</span><span class="n">callMethod</span><span class="o">(</span><span class="s">&quot;__repr__&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;());</span>
           <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">str</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">PyObject</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="o">...</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p><strong>Fig 4.18</strong> The PyObjectAdapter</p>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.4</strong></p>
<p>We have seen how polymorphism is provided by the C++ and Java
programming languages. Polymorphism is also provided by Python. Yet with
Python we don’t declare methods virtual, like C++, and we don’t have an
built-in class hierarchy like Java. How does polymorphism happen in
Python?</p>
<p><a class="reference internal" href="#exercise4-4"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="functions-as-values">
<h2>4.12. Functions as Values<a class="headerlink" href="#functions-as-values" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;__str__&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="p">(</span><span class="n">PyObject</span><span class="p">::</span><span class="o">*</span><span class="p">)(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;*</span><span class="p">))</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">PyObject</span><span class="p">::</span><span class="fm">__str__</span><span class="p">);</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PyCallable</span> <span class="kd">extends</span> <span class="n">PyObject</span> <span class="o">{</span>
     <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">;</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.19</strong> The PyCallable interface</p>
</div>
</div>
<div class="section" id="anonymous-inner-classes">
<h2>4.13. Anonymous Inner Classes<a class="headerlink" href="#anonymous-inner-classes" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">callMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">PyCallable</span> <span class="n">mbr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
     <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">mbr</span> <span class="o">=</span> <span class="o">(</span><span class="n">PyCallable</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">mbr</span><span class="o">.</span><span class="na">__call__</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYILLEGALOPERATIONEXCEPTION</span><span class="o">,</span>
         <span class="s">&quot;TypeError: &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">str</span><span class="o">()</span> <span class="o">+</span>
         <span class="s">&quot;&#39; object has no attribute &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="o">);</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.20</strong> The callMethod code</p>
</div>
</div>
<div class="section" id="type-casting-and-generics">
<h2>4.14. Type Casting and Generics<a class="headerlink" href="#type-casting-and-generics" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">private</span> <span class="n">ArrayList</span> <span class="nf">BodyPart</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">ArrayList</span> <span class="n">instructions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
         <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
         <span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
         <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;BEGIN&quot;</span><span class="o">))</span> <span class="o">{</span>
             <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Expected a BEGIN keyword.&quot;</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="o">....</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.21</strong> An ArrayList example</p>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ArrayList</span> <span class="n">bp</span> <span class="o">=</span> <span class="n">BodyPart</span><span class="o">();</span>
<span class="n">PyByteCode</span> <span class="n">byteCode</span> <span class="o">=</span> <span class="o">(</span><span class="n">PyByteCode</span><span class="o">)</span> <span class="n">bp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span>     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyByteCode</span><span class="o">&gt;</span> <span class="nf">BodyPart</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyByteCode</span><span class="o">&gt;</span> <span class="n">instructions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyByteCode</span><span class="o">&gt;();</span>
         <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
         <span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
         <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;BEGIN&quot;</span><span class="o">))</span> <span class="o">{</span>
             <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Expected a BEGIN keyword.&quot;</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.22</strong> An ArrayList example using generics</p>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">T</span> <span class="n">data</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="o">[</span><span class="mi">10</span><span class="o">];</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">&lt;</span> <span class="kd">class</span> <span class="nc">Key</span><span class="o">,</span>
           <span class="kd">class</span> <span class="nc">T</span><span class="o">,</span>
           <span class="kd">class</span> <span class="nc">Hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;,</span>
           <span class="kd">class</span> <span class="nc">Pred</span> <span class="o">=</span> <span class="n">equal_to</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;,</span>
           <span class="kd">class</span> <span class="nc">Alloc</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">&lt;</span> <span class="n">pair</span><span class="o">&lt;</span><span class="kd">const</span> <span class="n">Key</span><span class="o">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span>
           <span class="o">&gt;</span> <span class="kd">class</span> <span class="nc">unordered_map</span> <span class="o">{</span>
           <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p><strong>Fig 4.23</strong> The ordered_map template</p>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyByteCode</span><span class="o">&gt;</span> <span class="n">instructions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</pre></div>
</div>
</div>
<div class="section" id="auto-boxing-and-unboxing">
<h2>4.15. Auto-Boxing and Unboxing<a class="headerlink" href="#auto-boxing-and-unboxing" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span> <span class="n">intVec</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">Integer</span> <span class="n">y</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Integer</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">intList</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">intList</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">intValue</span><span class="p">();</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">intList</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="o">...</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">intList</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.5</strong></p>
<p>The Java <em>ArrayList</em> contains two overloaded methods called <em>remove</em>.
One takes an <em>int</em> parameter and removes an object at the specified
index in the <em>ArrayList</em>. The other takes an <em>Object</em> as a parameter and
removes the first instance of the object from the <em>ArrayList</em>. Why might
this pose a problem?</p>
<p><a class="reference internal" href="#exercise4-5"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="exception-handling-in-java-and-c">
<h2>4.16. Exception Handling in Java and C++<a class="headerlink" href="#exception-handling-in-java-and-c" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="o">*</span> <span class="n">PyRange</span><span class="o">::</span><span class="n">indexOf</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">increment</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">increment</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="p">(</span><span class="n">PYSTOPITERATIONEXCEPTION</span><span class="p">,</span><span class="s">&quot;Stop Iteration&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">increment</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="p">(</span><span class="n">PYSTOPITERATIONEXCEPTION</span><span class="p">,</span><span class="s">&quot;Stop Iteration&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">PyInt</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">increment</span><span class="o">*</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fig 4.24</strong> Throwing an exception in C++</p>
</div>
<div class="figboxcenter docutils container">
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">indexOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PyException</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">increment</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">increment</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span>
        <span class="n">PyException</span><span class="o">.</span><span class="na">ExceptionType</span><span class="o">.</span><span class="na">PYSTOPITERATIONEXCEPTION</span><span class="o">,</span>
        <span class="s">&quot;Stop Iteration&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">increment</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span>
        <span class="n">PyException</span><span class="o">.</span><span class="na">ExceptionType</span><span class="o">.</span><span class="na">PYSTOPITERATIONEXCEPTION</span><span class="o">,</span>
        <span class="s">&quot;Stop Iteration&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">PyInt</span><span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">increment</span> <span class="o">*</span> <span class="n">index</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>Fig 4.25</strong> Throwing an exception in Java</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">case</span> <span class="n">FOR_ITER</span><span class="p">:</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">safetyPop</span><span class="p">();</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">new</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">callMethod</span><span class="p">(</span><span class="s2">&quot;__next__&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="n">opStack</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
        <span class="n">opStack</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">PyException</span><span class="o">*</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">getExceptionType</span><span class="p">()</span> <span class="o">==</span> <span class="n">PYSTOPITERATIONEXCEPTION</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PC</span> <span class="o">=</span> <span class="n">operand</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
            <span class="n">throw</span> <span class="n">ex</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">delete</span> <span class="n">args</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span>
         <span class="s2">&quot;Delete of FOR_ITER args caused an exception for some reason.&quot;</span> <span class="o">&lt;&lt;</span>
         <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>Fig 4.26</strong> Catching an exception in C++</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="nl">FOR_ITER</span><span class="p">:</span>
    <span class="n">u</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="n">safetyPop</span><span class="p">();</span>
    <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">callMethod</span><span class="p">(</span><span class="s">&quot;__next__&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">opStack</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">opStack</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">PyException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">getExceptionType</span><span class="p">()</span> <span class="o">==</span> <span class="n">ExceptionType</span><span class="p">.</span><span class="n">PYSTOPITERATIONEXCEPTION</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">PC</span> <span class="o">=</span> <span class="n">operand</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Fig 4.27</strong> Catching an exception in Java</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">sigHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*********************************************************&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;            An Uncaught Exception Occurred&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*********************************************************&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Signal: &quot;</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">signum</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">SIGABRT</span><span class="p">:</span>
          <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Program Execution Aborted&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">SIGFPE</span><span class="p">:</span>
          <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Arithmetic or Overflow Error&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">SIGILL</span><span class="p">:</span>
          <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Illegal Instruction in Virtual Machine&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">SIGINT</span><span class="p">:</span>
          <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Execution Interrupted&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">SIGSEGV</span><span class="p">:</span>
          <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Illegal Memory Access&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">SIGTERM</span><span class="p">:</span>
          <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Termination Requested&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;---------------------------------------------------------&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;              The Exception&#39;s Traceback&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;---------------------------------------------------------&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">callStack</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">k</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;==========&gt; At PC=&quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">callStack</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getPC</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
      <span class="s">&quot; in this function. &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">callStack</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getCode</span><span class="p">().</span><span class="n">prettyString</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">;</span>

  <span class="n">signal</span><span class="p">(</span><span class="n">SIGABRT</span><span class="p">,</span><span class="n">sigHandler</span><span class="p">);</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span><span class="n">sigHandler</span><span class="p">);</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span><span class="n">sigHandler</span><span class="p">);</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">sigHandler</span><span class="p">);</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span><span class="n">sigHandler</span><span class="p">);</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span><span class="n">sigHandler</span><span class="p">);</span>
  <span class="p">...</span>
</pre></div>
</div>
<p><strong>Fig 4.28</strong> Signal handling</p>
</div>
</div>
<div class="section" id="signals">
<h2>4.17. Signals<a class="headerlink" href="#signals" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="jcoco-in-depth">
<h2>4.18. JCoCo In Depth<a class="headerlink" href="#jcoco-in-depth" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="the-scanner">
<h2>4.19. The Scanner<a class="headerlink" href="#the-scanner" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<blockquote>
<div><div class="figure">
<img alt="_images/cocolexer.png" src="_images/cocolexer.png" />
</div>
</div></blockquote>
<p><strong>Fig. 29</strong> The JCoCo Scanner FSM</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">PyToken</span> <span class="nf">getToken</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">needToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">needToken</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">lastToken</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">next</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">type</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="na">PYBADTOKEN</span><span class="o">;</span>
            <span class="n">foundOne</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">while</span> <span class="o">(!</span><span class="n">foundOne</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">colCount</span><span class="o">++;</span>
            <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">next</span><span class="o">;</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                    <span class="n">lex</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">colCount</span><span class="o">;</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lineCount</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">isLetter</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">Character</span><span class="o">.</span><span class="na">isDigit</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">11</span><span class="o">;</span>
                    <span class="o">...</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">...</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">foundOne</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">lex</span> <span class="o">+=</span> <span class="n">c</span><span class="o">;</span>
                <span class="n">next</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">type</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="na">PYEOFTOKEN</span><span class="o">;</span>
                    <span class="n">foundOne</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">unread</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span><span class="n">next</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">colCount</span><span class="o">--;</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PyToken</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PyToken</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">lex</span><span class="o">,</span> <span class="n">line</span><span class="o">,</span> <span class="n">column</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lastToken</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">putBackToken</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">needToken</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p><strong>Fig 4.30</strong> PyScanner getToken and putBackToken methods</p>
</div>
</div>
<div class="section" id="the-parser">
<h2>4.20. The Parser<a class="headerlink" href="#the-parser" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="nf">parse</span><span class="o">()</span> <span class="o">{</span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">PyAssemblyProg</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">putBackToken</span><span class="o">();</span>
         <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
         <span class="c1">// print error message</span>
         <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="c1">// unreachable</span>
     <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="nf">PyAssemblyProg</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">ClassFunctionListPart</span><span class="o">();</span>
     <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">tok</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">!=</span> <span class="n">TokenType</span><span class="o">.</span><span class="na">PYEOFTOKEN</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Excpected End Of File (EOF)&quot;</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="k">return</span> <span class="n">code</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="nf">ClassFunctionListPart</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">PyObject</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ClassFunDef</span><span class="o">();</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">codeList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;();</span>
     <span class="n">codeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
     <span class="n">codeList</span> <span class="o">=</span> <span class="n">ClassFunctionList</span><span class="o">(</span><span class="n">codeList</span><span class="o">);</span>
     <span class="k">return</span> <span class="n">codeList</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="nf">ClassFunctionList</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">codeList</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">putBackToken</span><span class="o">();</span>

     <span class="n">PyObject</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
     <span class="n">String</span> <span class="n">lexeme</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">lexeme</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Function&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">lexeme</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Class&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">obj</span> <span class="o">=</span> <span class="n">ClassFunDef</span><span class="o">();</span>
         <span class="n">codeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
         <span class="n">codeList</span> <span class="o">=</span> <span class="n">ClassFunctionList</span><span class="o">(</span><span class="n">codeList</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="k">return</span> <span class="n">codeList</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="kd">private</span> <span class="n">PyObject</span> <span class="nf">ClassFunDef</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">putBackToken</span><span class="o">();</span>
     <span class="n">PyObject</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Function&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">obj</span> <span class="o">=</span> <span class="n">FunDef</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Class&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">obj</span> <span class="o">=</span> <span class="n">ClassDef</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// throw  exception</span>
     <span class="o">}</span>
     <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.31</strong> PyParser.java excerpt 1</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">private</span> <span class="n">PyCode</span> <span class="nf">FunDef</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Function&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Expected Function keyword.&quot;</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Excpected a &#39;:&#39;.&quot;</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="n">PyToken</span> <span class="n">funName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">funName</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">!=</span> <span class="n">TokenType</span><span class="o">.</span><span class="na">PYIDENTIFIERTOKEN</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">badToken</span><span class="o">(</span><span class="n">funName</span><span class="o">,</span> <span class="s">&quot;Expected an identifier&quot;</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Expected a &#39;/&#39;&quot;</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="n">PyToken</span> <span class="n">numArgsToken</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="kt">int</span> <span class="n">numArgs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">numArgsToken</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">!=</span> <span class="n">TokenType</span><span class="o">.</span><span class="na">PYINTEGERTOKEN</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">badToken</span><span class="o">(</span><span class="n">numArgsToken</span><span class="o">,</span> <span class="s">&quot;Expected an integer token&quot;</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="n">numArgs</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">numArgsToken</span><span class="o">.</span><span class="na">getLex</span><span class="o">());</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
         <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">nestedClassFunctionList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;();</span>
     <span class="n">nestedClassFunctionList</span> <span class="o">=</span> <span class="n">ClassFunctionList</span><span class="o">(</span><span class="n">nestedClassFunctionList</span><span class="o">);</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">constants</span> <span class="o">=</span> <span class="n">ConstPart</span><span class="o">(</span><span class="n">nestedClassFunctionList</span><span class="o">);</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">locals</span> <span class="o">=</span> <span class="n">LocalsPart</span><span class="o">();</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">freevars</span> <span class="o">=</span> <span class="n">FreeVarsPart</span><span class="o">();</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">cellvars</span> <span class="o">=</span> <span class="n">CellVarsPart</span><span class="o">();</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">globals</span> <span class="o">=</span> <span class="n">GlobalsPart</span><span class="o">();</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyByteCode</span><span class="o">&gt;</span> <span class="n">instructions</span> <span class="o">=</span> <span class="n">BodyPart</span><span class="o">();</span>
     <span class="k">return</span> <span class="k">new</span> <span class="n">PyCode</span><span class="o">(</span><span class="n">funName</span><span class="o">.</span><span class="na">getLex</span><span class="o">(),</span> <span class="n">nestedClassFunctionList</span><span class="o">,</span> <span class="n">constants</span><span class="o">,</span>
             <span class="n">locals</span><span class="o">,</span> <span class="n">freevars</span><span class="o">,</span> <span class="n">cellvars</span><span class="o">,</span> <span class="n">globals</span><span class="o">,</span> <span class="n">instructions</span><span class="o">,</span> <span class="n">numArgs</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="nf">ConstPart</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">nestedCFList</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">constants</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;();</span>
     <span class="n">PyToken</span> <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Constants&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">putBackToken</span><span class="o">();</span>
         <span class="k">return</span> <span class="n">constants</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="n">tok</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">tok</span><span class="o">.</span><span class="na">getLex</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">badToken</span><span class="o">(</span><span class="n">tok</span><span class="o">,</span> <span class="s">&quot;Expected a &#39;:&#39;.&quot;</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="n">constants</span> <span class="o">=</span> <span class="n">ValueList</span><span class="o">(</span><span class="n">constants</span><span class="o">,</span> <span class="n">nestedCFList</span><span class="o">);</span>
     <span class="k">return</span> <span class="n">constants</span><span class="o">;</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.32</strong> PyParser.java excerpt 2</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CoCoAssemblyProg</span> <span class="p">::</span><span class="o">=</span> <span class="n">ClassFunctionListPart</span> <span class="n">EOF</span>
<span class="n">ClassFunctionListPart</span> <span class="p">::</span><span class="o">=</span> <span class="n">ClassFunDef</span> <span class="n">ClassFunctionList</span>
<span class="n">ClassFunctionList</span> <span class="p">::</span><span class="o">=</span> <span class="n">ClassFunDef</span> <span class="n">ClassFunctionList</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">null</span><span class="o">&gt;</span>
<span class="n">ClassFunDef</span> <span class="p">::</span><span class="o">=</span> <span class="n">ClassDef</span> <span class="o">|</span> <span class="n">FunDef</span>
<span class="n">FunDef</span> <span class="p">::</span><span class="o">=</span> <span class="n">Function</span> <span class="n">colon</span> <span class="n">Identifier</span> <span class="n">slash</span> <span class="n">Integer</span>
    <span class="n">ClassFunctionList</span> <span class="n">ConstPart</span> <span class="n">LocalsPart</span> <span class="n">FreeVarsPart</span>
    <span class="n">CellVarsPart</span> <span class="n">GlobalsPart</span> <span class="n">BodyPart</span>
<span class="n">ClassDef</span> <span class="p">::</span><span class="o">=</span> <span class="n">Class</span> <span class="n">colon</span> <span class="n">Identifier</span> <span class="p">[</span> <span class="p">(</span> <span class="n">Identifier</span> <span class="p">)</span> <span class="p">]</span>
    <span class="n">BEGIN</span> <span class="n">ClassFunctionList</span> <span class="n">END</span>
<span class="n">ConstPart</span> <span class="p">::</span><span class="o">=</span> <span class="o">&lt;</span><span class="n">null</span><span class="o">&gt;</span> <span class="o">|</span> <span class="n">Constants</span> <span class="n">colon</span> <span class="n">ValueList</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Function: main/0
Constants: None, &quot;Enter a list: &quot;
Locals: x, lst, b
Globals: input, split, print
BEGIN
          LOAD_GLOBAL         0
          LOAD_CONST          1
          CALL_FUNCTION       1
          STORE_FAST          0
          LOAD_FAST           0
          LOAD_ATTR           1
          CALL_FUNCTION       0
          STORE_FAST          1
          SETUP_LOOP    label02
          LOAD_FAST           1
          GET_ITER
label00:  FOR_ITER      label01
          STORE_FAST          2
          LOAD_GLOBAL         2
          LOAD_FAST           2
          CALL_FUNCTION       1
          POP_TOP
          JUMP_ABSOLUTE label00
label01:  POP_BLOCK
label02:  LOAD_CONST          0
          RETURN_VALUE
END
</pre></div>
</div>
</div></blockquote>
<p><strong>Fig. 4.33</strong> listiter.casm</p>
</div>
</div>
<div class="section" id="the-assembler">
<h2>4.21. The Assembler<a class="headerlink" href="#the-assembler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">BodyPart</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="n">BEGIN</span> <span class="o">&lt;</span><span class="n">InstructionList</span><span class="o">&gt;</span> <span class="n">END</span>
<span class="o">&lt;</span><span class="n">InstructionList</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="o">&lt;</span><span class="n">null</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">LabeledInstruction</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">InstructionList</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">LabeledInstruction</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="n">Identifier</span> <span class="n">colon</span> <span class="o">&lt;</span><span class="n">LabeledInstruction</span><span class="o">&gt;</span> <span class="o">|</span>
                         <span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">OpInstruction</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="n">STOP_CODE</span> <span class="o">|</span> <span class="n">NOP</span> <span class="o">|</span> <span class="n">POP_TOP</span> <span class="o">|</span> <span class="n">ROT_TWO</span> <span class="o">|</span> <span class="n">ROT_THREE</span> <span class="o">|</span> <span class="o">...</span>
</pre></div>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>private ArrayList&lt;PyByteCode&gt; BodyPart() {
    ArrayList&lt;PyByteCode&gt; instructions = new ArrayList&lt;PyByteCode&gt;();
    PyToken tok = this.in.getToken();
    this.target.clear();
    this.index = 0;
    if (!tok.getLex().equals(&quot;BEGIN&quot;)) {
        badToken(tok, &quot;Expected a BEGIN keyword.&quot;);
    }
    instructions = InstructionList(instructions);
    //find the target of any labels in the byte code instructions
    for (int i = 0; i &lt; instructions.size(); i++) {
        PyByteCode inst = instructions.get(i);
        String label = inst.getLabel();
        if (!label.equals(&quot;&quot;)) {
            String op = inst.getOpCodeName();
            instructions.remove(instructions.get(i));
            instructions.add(i, new PyByteCode(op, target.get(label)));
        }
    }
    tok = this.in.getToken();
    if (!tok.getLex().equals(&quot;END&quot;)) {
        badToken(tok, &quot;Expected a END keyword.&quot;);
    }
    return instructions;
}

private PyByteCode LabeledInstruction() {
    PyToken tok1 = this.in.getToken();
    String tok1Lex = tok1.getLex();
    PyToken tok2 = this.in.getToken();
    String tok2Lex = tok2.getLex();
    if (tok2Lex.equals(&quot;:&quot;)) {
        if (!this.target.containsKey(tok1Lex)) {
            this.target.put(tok1Lex, this.index);
        } else {
            badToken(tok1, &quot;Duplicate label found.&quot;);
        }
        return LabeledInstruction();
    }
  // code omitted here.
}
</pre></div>
</div>
<p><strong>Fig 4.34</strong> Assembling a program</p>
</div>
</div>
<div class="section" id="bytecode">
<h2>4.22. ByteCode<a class="headerlink" href="#bytecode" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">class</span> <span class="nc">PyByteCode</span> <span class="o">{</span>
     <span class="kd">enum</span> <span class="n">PyOpCode</span> <span class="o">{</span>
         <span class="n">BINARY_ADD</span> <span class="o">(</span><span class="mi">0</span><span class="o">),</span>
         <span class="n">LOAD_CONST</span> <span class="o">(</span><span class="mi">1</span><span class="o">),</span>
         <span class="n">COMPARE_OP</span> <span class="o">(</span><span class="mi">1</span><span class="o">),</span>
         <span class="n">CALL_FUNCTION</span> <span class="o">(</span><span class="mi">1</span><span class="o">),</span>
         <span class="o">...;</span>
         <span class="kd">private</span> <span class="kt">int</span> <span class="n">args</span><span class="o">;</span>
         <span class="n">PyOpCode</span><span class="o">(</span><span class="kt">int</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">this</span><span class="o">.</span><span class="na">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
         <span class="o">}</span>
         <span class="kd">public</span> <span class="kt">int</span> <span class="nf">args</span><span class="o">()</span> <span class="o">{</span>
             <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">args</span><span class="o">;</span>
         <span class="o">}</span>
     <span class="o">};</span>

     <span class="kd">private</span> <span class="kd">static</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyOpCode</span><span class="o">&gt;</span> <span class="n">OpCodeMap</span> <span class="o">=</span> <span class="n">createOpCodeMap</span><span class="o">();</span>
     <span class="kd">private</span> <span class="kd">static</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ArgMap</span> <span class="o">=</span> <span class="n">createArgMap</span><span class="o">();</span>

     <span class="kd">private</span> <span class="kd">static</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyOpCode</span><span class="o">&gt;</span> <span class="nf">createOpCodeMap</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyOpCode</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyOpCode</span><span class="o">&gt;();</span>
         <span class="k">for</span> <span class="o">(</span><span class="n">PyOpCode</span> <span class="n">opcode</span> <span class="o">:</span> <span class="n">PyOpCode</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">opcode</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="n">opcode</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">private</span> <span class="kd">static</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">createArgMap</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
         <span class="k">for</span> <span class="o">(</span><span class="n">PyOpCode</span> <span class="n">opcode</span> <span class="o">:</span> <span class="n">PyOpCode</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">opcode</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="n">opcode</span><span class="o">.</span><span class="na">args</span><span class="o">());</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="c1">// code omitted here.</span>
     <span class="kd">public</span> <span class="nf">PyByteCode</span><span class="o">(</span><span class="n">String</span> <span class="n">opcode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">operand</span><span class="o">)</span>  <span class="o">{</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">OpCodeMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">opcode</span><span class="o">))</span> <span class="o">{</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYILLEGALOPERATIONEXCEPTION</span><span class="o">,</span>
                                     <span class="s">&quot;Unknown opcode &quot;</span><span class="o">+</span><span class="n">opcode</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="k">this</span><span class="o">.</span><span class="na">opcode</span> <span class="o">=</span> <span class="n">OpCodeMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">opcode</span><span class="o">);</span>
         <span class="k">this</span><span class="o">.</span><span class="na">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">;</span>
         <span class="k">this</span><span class="o">.</span><span class="na">label</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="c1">// code omitted here.</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.35</strong> Static initialization</p>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">inst</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">getInstructions</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">PC</span><span class="o">);</span>
<span class="k">switch</span> <span class="o">(</span><span class="n">inst</span><span class="o">.</span><span class="na">getOpCode</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">LOAD_FAST</span><span class="o">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">locals</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">getLocals</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">operand</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">u</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYILLEGALOPERATIONEXCEPTION</span><span class="o">,</span>
                    <span class="s">&quot;NameError: name &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">getLocals</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">operand</span><span class="o">)</span> <span class="o">...</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">opStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">u</span><span class="o">);</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="jcocos-class-and-interface-type-hierarchy">
<h2>4.23. JCoCo’s Class and Interface Type Hierarchy<a class="headerlink" href="#jcocos-class-and-interface-type-hierarchy" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="figure">
<a class="reference internal image-reference" href="_images/pytypes.png"><img alt="JCoCo Type Hierarchy" src="_images/pytypes.png" style="width: 7in;" /></a>
</div>
<p><strong>Fig. 4.36</strong> JCoCo Type Hierarchy</p>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">PyType</span> <span class="n">typeType</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PyType</span><span class="o">(</span><span class="s">&quot;type&quot;</span><span class="o">,</span> <span class="n">PyTypeId</span><span class="o">.</span><span class="na">PyTypeType</span><span class="o">);</span>
<span class="n">PyTypes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">PyTypeId</span><span class="o">.</span><span class="na">PyTypeType</span><span class="o">,</span> <span class="n">typeType</span><span class="o">);</span>
</pre></div>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.6</strong></p>
<p>The existence of a class named <em>PySuper</em> suggests that classes can be
built dynamically (i.e. at run-time). The need for PySuper stems from
needing to look up the superclass dynamically, while the program is
running, because in general it cannot be known before its use. What
instruction in appendix&nbsp;[appendices:appendix-a] is responsible for
getting JCoCo ready to dynamically create a class?</p>
<p><a class="reference internal" href="#exercise4-6"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="code">
<h2>4.24. Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kn">package</span> <span class="nn">jcoco</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">jcoco.PyException.ExceptionType</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">jcoco.PyType.PyTypeId</span><span class="o">;</span>

 <span class="kd">class</span> <span class="nc">PyCode</span>  <span class="kd">extends</span> <span class="n">PyObjectAdapter</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">nestedClassFunctions</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">locals</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">freevars</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">cellvars</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">globals</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">consts</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyByteCode</span><span class="o">&gt;</span> <span class="n">instructions</span><span class="o">;</span>
     <span class="kd">private</span> <span class="kt">int</span> <span class="n">argCount</span><span class="o">;</span>
     <span class="o">...</span> <span class="c1">// methods and constructors omitted.</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.37</strong> The PyCode class instance variables</p>
</div>
</div>
<div class="section" id="functions">
<h2>4.25. Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="nf">PyFunction</span><span class="o">(</span><span class="n">PyCode</span> <span class="n">theCode</span><span class="o">,</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">theGlobals</span><span class="o">,</span>
         <span class="n">PyObject</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">PyTuple</span> <span class="n">tuple</span> <span class="o">=</span> <span class="o">(</span><span class="n">PyTuple</span><span class="o">)</span><span class="n">env</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">cellvars</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyCell</span><span class="o">&gt;();</span>
     <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">theCode</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">globals</span> <span class="o">=</span> <span class="n">theGlobals</span><span class="o">;</span>

     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">theCode</span><span class="o">.</span><span class="na">getFreeVars</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">cellvars</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">theCode</span><span class="o">.</span><span class="na">getFreeVars</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span>
                           <span class="o">(</span><span class="n">PyCell</span><span class="o">)</span><span class="n">tuple</span><span class="o">.</span><span class="na">getVal</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
     <span class="o">}</span>

     <span class="n">PyFunction</span> <span class="n">self</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__call__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span>  <span class="o">{</span>
             <span class="k">return</span> <span class="n">self</span><span class="o">.</span><span class="na">__call__</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">});</span>
 <span class="o">}</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span>  <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">getArgCount</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYWRONGARGCOUNTEXCEPTION</span><span class="o">,</span>
                         <span class="s">&quot;Type Error: expected &quot;</span><span class="o">+</span><span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">getArgCount</span><span class="o">()</span> <span class="o">+</span>
                         <span class="s">&quot; arguments, got &quot;</span><span class="o">+</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
     <span class="o">}</span>
     <span class="n">PyFrame</span> <span class="n">frame</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PyFrame</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">globals</span><span class="o">,</span>
                            <span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">getConsts</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">cellvars</span><span class="o">);</span>
     <span class="n">PyObject</span> <span class="n">result</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
     <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.38</strong> The PyFunction constructor and __call__ method</p>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.7</strong></p>
<p>What are the free variables and bound variables in this Python function?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">aVal</span> <span class="o">+</span> <span class="n">lstInts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p><a class="reference internal" href="#exercise4-7"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="classes">
<h2>4.26. Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="nf">PyClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">nestedclassesandfuns</span><span class="o">,</span>
             <span class="n">String</span> <span class="n">baseClass</span><span class="o">,</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">globals</span><span class="o">)</span>  <span class="o">{</span>
     <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">PyTypeId</span><span class="o">.</span><span class="na">PyClassType</span><span class="o">);</span>
     <span class="k">this</span><span class="o">.</span><span class="na">baseClass</span> <span class="o">=</span> <span class="n">baseClass</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">classesandfuns</span> <span class="o">=</span> <span class="n">nestedclassesandfuns</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">globals</span> <span class="o">=</span> <span class="o">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;)</span><span class="n">globals</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">attrs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__name__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyStr</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">classesandfuns</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">classesandfuns</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getType</span><span class="o">().</span><span class="na">typeId</span><span class="o">()</span> <span class="o">==</span> <span class="n">PyTypeId</span><span class="o">.</span><span class="na">PyCodeType</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">PyCode</span> <span class="n">code</span> <span class="o">=</span> <span class="o">(</span><span class="n">PyCode</span><span class="o">)</span> <span class="n">classesandfuns</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
             <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;();</span>
             <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">code</span><span class="o">.</span><span class="na">getFreeVars</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                 <span class="n">String</span> <span class="n">freeVar</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="na">getFreeVars</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                 <span class="k">if</span> <span class="o">(</span><span class="n">freeVar</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;__class__&quot;</span><span class="o">))</span> <span class="o">{</span>
                     <span class="n">env</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PyCell</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
                 <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                     <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYMATCHEXCEPTION</span><span class="o">,</span>
                      <span class="s">&quot;Error: Found unexpected freevar in class declaration.&quot;</span><span class="o">);</span>
                 <span class="o">}</span>
             <span class="o">}</span>
             <span class="n">PyFunction</span> <span class="n">fun</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PyFunction</span><span class="o">((</span><span class="n">PyCode</span><span class="o">)</span> <span class="n">classesandfuns</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span>
                 <span class="n">globals</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyTuple</span><span class="o">(</span><span class="n">env</span><span class="o">));</span>
             <span class="k">this</span><span class="o">.</span><span class="na">attrs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">fun</span><span class="o">.</span><span class="na">callName</span><span class="o">(),</span> <span class="n">fun</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">classesandfuns</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getType</span><span class="o">().</span><span class="na">typeId</span><span class="o">()</span> <span class="o">==</span>
                   <span class="n">PyTypeId</span><span class="o">.</span><span class="na">PyTypeType</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">PyClass</span> <span class="n">cls</span> <span class="o">=</span> <span class="o">(</span><span class="n">PyClass</span><span class="o">)</span> <span class="n">classesandfuns</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
             <span class="k">this</span><span class="o">.</span><span class="na">attrs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cls</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">cls</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYMATCHEXCEPTION</span><span class="o">,</span>
                        <span class="s">&quot;TypeError: expected a Function or Class, got &quot;</span><span class="o">+</span>
                        <span class="n">classesandfuns</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getType</span><span class="o">().</span><span class="na">str</span><span class="o">());</span>
         <span class="o">}</span>
     <span class="o">}</span>
 <span class="o">}</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initInstance</span><span class="o">(</span><span class="n">PyObjectAdapter</span> <span class="n">obj</span><span class="o">)</span>  <span class="o">{</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">baseClass</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">{</span>
         <span class="o">((</span><span class="n">PyClass</span><span class="o">)</span><span class="n">globals</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">baseClass</span><span class="o">)).</span><span class="na">initInstance</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">name</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">attrs</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">attrs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">getType</span><span class="o">().</span><span class="na">typeId</span><span class="o">()</span> <span class="o">==</span>
               <span class="n">PyTypeId</span><span class="o">.</span><span class="na">PyFunctionType</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">obj</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyMethod</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">obj</span><span class="o">,</span>
                 <span class="o">(</span><span class="n">PyCallable</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">attrs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">)));</span>
         <span class="o">}</span>
     <span class="o">}</span>
 <span class="o">}</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span>  <span class="o">{</span>
     <span class="n">PyObjectAdapter</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PyObjectInst</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
     <span class="n">initInstance</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
     <span class="o">((</span><span class="n">PyMethod</span><span class="o">)</span> <span class="n">obj</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;__init__&quot;</span><span class="o">)).</span><span class="na">__call__</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
     <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.39</strong> The PyClass constructor and __call__ method</p>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">z</span> <span class="o">=</span> <span class="kt">int</span><span class="o">.</span><span class="na">__add__</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python3</span><span class="o">.</span><span class="mi">2</span>
<span class="n">Python</span> <span class="mf">3.2</span><span class="o">.</span><span class="mi">5</span> <span class="p">(</span><span class="n">v3</span><span class="o">.</span><span class="mf">2.5</span><span class="p">:</span><span class="n">cef745775b65</span><span class="p">,</span> <span class="n">May</span> <span class="mi">13</span> <span class="mi">2013</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">00</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.2</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">build</span> <span class="mi">5666</span><span class="p">)</span> <span class="p">(</span><span class="n">dot</span> <span class="mi">3</span><span class="p">)]</span> <span class="n">on</span> <span class="n">darwin</span>
<span class="n">Type</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="s2">&quot;copyright&quot;</span><span class="p">,</span> <span class="s2">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s2">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">int</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="mi">10</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="methods">
<h2>4.27. Methods<a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span>  <span class="o">{</span>
     <span class="n">args</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">self</span><span class="o">);</span>
     <span class="n">PyObject</span> <span class="n">result</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="na">__call__</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
     <span class="c1">//take self back out of args because when a method</span>
     <span class="c1">//is called no one would suspect that a side-effect</span>
     <span class="c1">//was that args was mutated.</span>
     <span class="n">args</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">);</span>
     <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.40</strong> The PyMethod __call__ method</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python3</span><span class="o">.</span><span class="mi">2</span>
<span class="n">Python</span> <span class="mf">3.2</span><span class="o">.</span><span class="mi">5</span> <span class="p">(</span><span class="n">v3</span><span class="o">.</span><span class="mf">2.5</span><span class="p">:</span><span class="n">cef745775b65</span><span class="p">,</span> <span class="n">May</span> <span class="mi">13</span> <span class="mi">2013</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">00</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.2</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">build</span> <span class="mi">5666</span><span class="p">)</span> <span class="p">(</span><span class="n">dot</span> <span class="mi">3</span><span class="p">)]</span> <span class="n">on</span> <span class="n">darwin</span>
<span class="n">Type</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="s2">&quot;copyright&quot;</span><span class="p">,</span> <span class="s2">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s2">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="mi">10</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">6</span>
<span class="mi">10</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.8</strong></p>
<p>Consider the code in the example below. When a Dog object is created its
<em>__init__</em> method implicitly gets called. We never explicitly call
the constructor on a Python object. Where does <em>__init__</em> get called
in the JCoCo virtual machine?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mydog</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="s2">&quot;Mesa&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#exercise4-8"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="jcoco-exceptions-and-tracebacks">
<h2>4.28. JCoCo Exceptions and Tracebacks<a class="headerlink" href="#jcoco-exceptions-and-tracebacks" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">PC</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
   <span class="kt">boolean</span> <span class="n">handled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
   <span class="n">JCoCo</span><span class="o">.</span><span class="na">pushFrame</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
   <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">try</span> <span class="o">{</span>
       <span class="n">inst</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">getInstructions</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">PC</span><span class="o">);</span>
       <span class="k">this</span><span class="o">.</span><span class="na">PC</span><span class="o">++;</span>
       <span class="n">opcode</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="na">getOpCode</span><span class="o">();</span>
       <span class="n">operand</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="na">getOperand</span><span class="o">();</span>
       <span class="k">switch</span> <span class="o">(</span><span class="n">opcode</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// instructions omitted</span>
         <span class="k">case</span> <span class="n">SETUP_EXCEPT</span><span class="o">:</span>
           <span class="k">this</span><span class="o">.</span><span class="na">blockStack</span><span class="o">.</span><span class="na">push</span><span class="o">(-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">operand</span><span class="o">);</span>
           <span class="n">opStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="k">new</span> <span class="n">PyMarker</span><span class="o">());</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="o">}</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PyException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">int</span> <span class="n">exitAddress</span><span class="o">;</span>
       <span class="kt">boolean</span> <span class="n">found</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
       <span class="k">while</span> <span class="o">(!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">blockStack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
         <span class="n">exitAddress</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">blockStack</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">exitAddress</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">found</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
           <span class="k">if</span> <span class="o">(!</span><span class="n">opStack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">PyObject</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">opStack</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
             <span class="k">while</span> <span class="o">(!</span><span class="n">obj</span><span class="o">.</span><span class="na">str</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Marker&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opStack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">obj</span> <span class="o">=</span> <span class="n">opStack</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
             <span class="o">}</span>
           <span class="o">}</span>
           <span class="k">this</span><span class="o">.</span><span class="na">opStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getTraceBack</span><span class="o">());</span> <span class="c1">//The traceback at TOS2</span>
           <span class="k">this</span><span class="o">.</span><span class="na">opStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="c1">//The exception at TOS1</span>
           <span class="k">this</span><span class="o">.</span><span class="na">opStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="c1">//the exception at TOS</span>
           <span class="k">this</span><span class="o">.</span><span class="na">PC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">exitAddress</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">blockStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
         <span class="o">}</span>
       <span class="o">}</span>
       <span class="k">if</span> <span class="o">(!</span><span class="n">found</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">ex</span><span class="o">.</span><span class="na">tracebackAppend</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
         <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
       <span class="o">}</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">PyException</span> <span class="n">ex</span> <span class="o">=</span>
          <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYILLEGALOPERATIONEXCEPTION</span><span class="o">,</span>
          <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()+</span><span class="s">&quot; while executing instruction &quot;</span><span class="o">+</span><span class="n">inst</span><span class="o">.</span><span class="na">getOpCodeName</span><span class="o">());</span>
       <span class="n">ex</span><span class="o">.</span><span class="na">tracebackAppend</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
       <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
     <span class="o">}</span>
   <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.41</strong> A synopsis of exception handling in JCoCo</p>
</div>
</div>
<div class="section" id="magic-methods">
<h2>4.29. Magic Methods<a class="headerlink" href="#magic-methods" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="nf">PyObjectAdapter</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PyObject()&quot;</span><span class="o">;</span>
     <span class="n">type</span> <span class="o">=</span> <span class="n">PyType</span><span class="o">.</span><span class="na">PyTypeId</span><span class="o">.</span><span class="na">PyClassType</span><span class="o">;</span>
     <span class="n">PyObjectAdapter</span> <span class="n">self</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
     <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__str__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyBaseCallable</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYWRONGARGCOUNTEXCEPTION</span><span class="o">,</span>
                 <span class="s">&quot;TypeError: expected 0 argument, got &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
             <span class="o">}</span>
             <span class="k">return</span> <span class="k">new</span> <span class="n">PyStr</span><span class="o">(</span><span class="n">self</span><span class="o">.</span><span class="na">str</span><span class="o">());</span>
         <span class="o">}</span>
     <span class="o">});</span>
     <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__hash__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyBaseCallable</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYILLEGALOPERATIONEXCEPTION</span><span class="o">,</span>
             <span class="s">&quot;TypeError: unhashable type: &#39;&quot;</span> <span class="o">+</span> <span class="n">self</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">str</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">});</span>
     <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__repr__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyBaseCallable</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYWRONGARGCOUNTEXCEPTION</span><span class="o">,</span>
                 <span class="s">&quot;TypeError: expected 0 argument, got &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
             <span class="o">}</span>
             <span class="k">return</span> <span class="n">self</span><span class="o">.</span><span class="na">callMethod</span><span class="o">(</span><span class="s">&quot;__str__&quot;</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">});</span>
     <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__iter__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyBaseCallable</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYWRONGARGCOUNTEXCEPTION</span><span class="o">,</span>
                 <span class="s">&quot;TypeError: expected 0 argument, got &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
             <span class="o">}</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYILLEGALOPERATIONEXCEPTION</span><span class="o">,</span>
             <span class="s">&quot;TypeError: &#39;&quot;</span> <span class="o">+</span> <span class="n">self</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">str</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;&#39; object is not iterable&quot;</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">});</span>
     <span class="k">this</span><span class="o">.</span><span class="na">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__type__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyBaseCallable</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">PyObject</span> <span class="nf">__call__</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">throw</span> <span class="k">new</span> <span class="n">PyException</span><span class="o">(</span><span class="n">ExceptionType</span><span class="o">.</span><span class="na">PYWRONGARGCOUNTEXCEPTION</span><span class="o">,</span>
                 <span class="s">&quot;TypeError: expected 0 argument, got &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
             <span class="o">}</span>
             <span class="k">return</span> <span class="o">(</span><span class="n">PyObject</span><span class="o">)</span> <span class="n">self</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>
         <span class="o">}</span>
     <span class="o">});</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig: 4.42</strong> PyObjectAdapter’s constructor</p>
</div>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="kd">static</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyCallable</span><span class="o">&gt;</span> <span class="nf">funs</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyCallable</span><span class="o">&gt;</span> <span class="n">funs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyCallable</span><span class="o">&gt;();</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__hash__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__add__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__sub__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__mul__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__pow__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__truediv__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__floordiv__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__mod__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__eq__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__ne__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__lt__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__le__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__gt__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__ge__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__float__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__int__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__bool__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__str__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
     <span class="k">return</span> <span class="n">funs</span><span class="o">;</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.43</strong> PyInt’s additional magic methods</p>
</div>
<div class="exercise docutils container">
<p><strong>Practice 4.9</strong></p>
<p>How can an object or class override the default behavior of a magic
method like the <em>__str__</em> method without changing the JCoCo virtual
machine itself?</p>
<p><a class="reference internal" href="#exercise4-9"><span class="std std-ref">You can check your answer(s) at the end of the chapter.</span></a></p>
</div>
</div>
<div class="section" id="dictionaries">
<h2>4.30. Dictionaries<a class="headerlink" href="#dictionaries" title="Permalink to this headline">¶</a></h2>
<div class="figboxcenter docutils container">
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">d</span><span class="p">[</span><span class="s2">&quot;hello&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;goodbye&quot;</span>
   <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dog!&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cat!&quot;</span>
   <span class="n">d</span><span class="p">[</span><span class="s2">&quot;young&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;old&quot;</span>
   <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;hello young dog!&quot;</span>
   <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
     <span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
   <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
     <span class="k">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
     <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
   <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
   <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
 <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.44</strong> dicttest.py</p>
</div>
<div class="section" id="two-new-classes">
<h3>4.30.1. Two New Classes<a class="headerlink" href="#two-new-classes" title="Permalink to this headline">¶</a></h3>
<div class="figboxcenter docutils container">
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kn">package</span> <span class="nn">jcoco</span><span class="o">;</span>

 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">PyDict</span> <span class="kd">extends</span> <span class="n">PyPrimitiveTypeAdapter</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">,</span> <span class="n">PyObject</span><span class="o">&gt;();</span>
     <span class="kd">public</span> <span class="nf">PyDict</span><span class="o">()</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">();</span>
         <span class="n">initMethods</span><span class="o">(</span><span class="n">funs</span><span class="o">());</span>
     <span class="o">}</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVal</span><span class="o">(</span><span class="n">PyObject</span> <span class="n">key</span><span class="o">,</span> <span class="n">PyObject</span> <span class="n">val</span><span class="o">)</span> <span class="o">{...}</span>
     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">PyType</span> <span class="nf">getType</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">JCoCo</span><span class="o">.</span><span class="na">PyTypes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">PyTypeId</span><span class="o">.</span><span class="na">PyDictType</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">str</span><span class="o">()</span> <span class="o">{...}</span>
     <span class="kd">public</span> <span class="kd">static</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyCallable</span><span class="o">&gt;</span> <span class="nf">funs</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyCallable</span><span class="o">&gt;</span> <span class="n">funs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PyCallable</span><span class="o">&gt;();</span>
         <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__getitem__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
         <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__setitem__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
         <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__len__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
         <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;__iter__&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
         <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;keys&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
         <span class="n">funs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;values&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PyCallableAdapter</span><span class="o">()</span> <span class="o">{...});</span>
         <span class="k">return</span> <span class="n">funs</span><span class="o">;</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig 4.45</strong> Outline of PyDict.java</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="n">public</span> <span class="nb">int</span> <span class="n">hashCode</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">args</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">PyInt</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyInt</span><span class="p">)</span> <span class="n">this</span><span class="o">.</span><span class="n">callMethod</span><span class="p">(</span><span class="s2">&quot;__hash__&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">getVal</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="n">Iterator</span><span class="o">&lt;</span><span class="n">HashMap</span><span class="o">.</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">&gt;&gt;</span> <span class="n">it</span><span class="p">;</span>
<span class="n">it</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">entrySet</span><span class="p">()</span><span class="o">.</span><span class="n">iterator</span><span class="p">();</span>
<span class="k">while</span> <span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">hasNext</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">HashMap</span><span class="o">.</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">PyObject</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">&gt;</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
  <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">getKey</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="two-new-types">
<h3>4.30.2. Two New Types<a class="headerlink" href="#two-new-types" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="two-new-instructions">
<h3>4.30.3. Two New Instructions<a class="headerlink" href="#two-new-instructions" title="Permalink to this headline">¶</a></h3>
<div class="figboxcenter docutils container">
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
      <span class="n">d</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;Kent&quot;</span><span class="p">:</span><span class="s2">&quot;Denise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sophus&quot;</span><span class="p">:</span><span class="s2">&quot;Addie&quot;</span><span class="p">}</span>
      <span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><strong>Fig. 4.46</strong> Initializing a dictionary</p>
</div>
</div>
</div>
<div class="section" id="chapter-summary">
<h2>4.31. Chapter Summary<a class="headerlink" href="#chapter-summary" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="review-questions">
<h2>4.32. Review Questions<a class="headerlink" href="#review-questions" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>What does static type checking mean? Does C++ have it? Does Python
have it? Does Java have it?</li>
<li>What are the names and purposes of the two programs that make up the
Java environment for executing programs?</li>
<li>What is the number one problem that C/C++ programs must deal with?
Why is this not a problem for Java and Python programs?</li>
<li>What does the <em>make</em> tool do and how does it work for C++ programs?</li>
<li>Is there an equivalent to the <em>make</em> tool for Java programs?</li>
<li>How does the C++ compiler distinguish between macro processor
directives and C/C++ statements?</li>
<li>What is a namespace in C++? What is comparable to a namespace in
Java? In Python?</li>
<li>What is the default executable name for a compiled C++ program?</li>
<li>What is separate compilation and why is it important?</li>
<li>What is dynamic linking? Does it happen in C++ or in Java? Why is it
important?</li>
<li>Which environment has garbage collection built in, C++ or Java?</li>
<li>What are the advantages of garbage collection?</li>
<li>Are there any drawbacks to garbage collection?</li>
<li>What is a destructor and when is it needed?</li>
<li>What do you have to write to get a polymorphic method in C++?</li>
<li>What is the purpose of polymorphism?</li>
<li>What is the purpose of inheritance?</li>
<li>How do interfaces and classes differ in Java? How are they similar?
How are they different?</li>
<li>What is an adapter class? Why are they useful?</li>
<li>What is a callback and how are they usually implemented in Java?</li>
<li>What are generics? Why are they convenient?</li>
<li>What is a template? How do you declare a vector in C++?</li>
<li>What is auto-boxing and unboxing?</li>
<li>How is a function represented as a value in Java?</li>
<li>What is an anonymous class?</li>
<li>What is the <em>type(6)</em> in JCoCo and Python? How about the
<em>type(type(6))</em>? How about the <em>type(type(type(6)))</em>? Why isn’t it
interesting to go any further?</li>
<li>The JCoCo scanner is based on a finite state machine. How is the
finite state machine implemented? What are the major constructs used
by a finite state machine?</li>
<li>Does the JCoCo parser run bottom-up or top-down?</li>
<li>In JCoCo how are a PyCode object and a PyFunction object related?</li>
<li>What is a traceback and why is it important?</li>
<li>What is the purpose of a PyMethod class?</li>
<li>Arriving at hash values for hashable objects in Java is trivial.
Describe how JCoCo determines hash values for objects in the
implementation of PyDict objects.</li>
</ol>
</div>
<div class="section" id="exercises">
<h2>4.33. Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Alter the finite state machine of PyScanner.java to allow strings to
include the escape character. Any character following the backslash,
or escape character, in a string should be allowed. This project can
be implemented by altering the PyScanner.java class to allow the
escape character to appear within a string. Hint: Two extra states
may be needed to implement this code. Note that JCoCo will already
allow pretty much any character, including tabs and newline
characters, to be included in a string constant. The only characters
that pose problems are single and double quotes. The escape character
should not be included in the constant string, only the character
that follows the escape character.</p>
</li>
<li><p class="first">Implement true division and floor division for floats in JCoCo. Write
a test program to thoroughly test these new operations supported by
floats. The test program and the source code are both required for
the solution to this problem. You may use the disassembler to help
generate your test program.</p>
</li>
<li><p class="first">Alter the JCoCo grammar to allow each line of a function’s code to be
either a JCoCo instruction or a source code line. Any source code
line should be preceeded by a pound sign, a line number, and a colon
followed by the text of the source code line. A source code line
would reflect a line from a source language other than JCoCo which
was compiled to the JCoCo assembly language. Then, when an uncaught
exception occurs in the JCoCo program, the traceback should be
printed along with the source code line that caused the exception.
This is a challenging exercise and requires changes to the scanner,
parser, internal storage of PyCode objects, and traceback handling.</p>
</li>
<li><p class="first">Add a dictionary object type to JCoCo by following the description at
the end of this chapter. This project requires significant
programming and there are pieces in the last part of the chapter that
are left out. However, the provided code samples along with other
similar code in the JCoCo project provides enough details to be able
to complete it. When done, the successful project will be able to run
the disassembled code from figures and . The output should appear to
be identical to the output produced by running the Python programs.
However, the order of keys may be different since dictionaries are
implemented with an unordered_map datatype.</p>
</li>
<li><p class="first">Empty type calls produce <em>empty</em> results in Python but not in JCoCo.
For instance, when <em>int()</em> is called in Python, the object 0 is
created. In JCoCo this produces an error. Use Python to determine
what should happen for all the empty type calls that JCoCo supports.
Then modify CoCo so it will behave in a similar fashion.</p>
</li>
<li><p class="first">Add a <em>set</em> datatype to JCoCo. Lookup the <em>set</em> datatype in Python
documentation. Include support in your <em>set</em> datatype to support
contructing a set, union, intersection, mutating union, and mutating
set difference along with set cardinality, membership, and addition
of an element to the set. Write a Python test program and disassemble
it. Then run your test program to test your set datatype.</p>
</li>
<li><p class="first">Modify JCoCo to allow instructions like <em>LOAD_FAST x</em> in addition to
<em>LOAD_FAST 0</em>. Currently, the LOAD_FAST and STORE_FAST
instructions insist on an integer operand. If an identifier operand
were provided then the identifier must exist in the sequence of
<em>LOCALS</em>. If it does not, the parser should signal an error.
Internally, the LOAD_FAST and STORE_FAST instructions should not
change. The conversion from identifier to integer should happen in
the parser. Convert the <em>LOAD_GLOBAL</em>, and <em>LOAD_ATTR</em> instructions
to allow either an identifier or integer operand in the same manner.
Do not try to modify the <em>LOAD_CONST</em> instruction since it would be
impossible to distinguish between indices and values for constants.</p>
<p>This project is not too hard to implement. Labels are already
converted to offsets in the parser in the <em>BodyPart</em> method. That
code has to be modified slightly to handle identifiers for things
other than labels. The identifiers for the load and store
instructions can be converted to integer operands in the <em>FunDef</em>
function.</p>
</li>
<li><p class="first">Currently the assembler has three different load instructions
including <em>LOAD_FAST</em>, <em>LOAD_GLOBAL</em>, and <em>LOAD_DEREF</em> that all
use indices into different lists as operands. Define a new pseudo
<em>LOAD</em> instruction that lets you specify an identifier for a value to
load. For instance <em>LOAD x</em> would result in scanning the <em>LOCALS</em>
list for <em>x</em>. If <em>x</em> were found in the first posiition of the locals
list, then the <em>LOAD x</em> would be changed to a <em>LOAD_FAST 0</em>
instruction. Otherwise, if <em>x</em> was not in the list of locals, then
the <em>GLOBALS</em> would be scanned next and if <em>x</em> were found there a
<em>LOAD_GLOBAL</em> instruction would replace the <em>LOAD</em> pseudo
instruction. If <em>x</em> was not found in the globals, then the cellvars
could be scanned and finally the freevars. Create a <em>STORE</em> pseudo
instruction as well for the <em>STORE_FAST</em> and <em>STORE_DEREF</em>
instructions.</p>
<p>Do not try to implement the pseudo instructions for any of the other
load or store instructions. For instance, it would be impossible to
know whether a <em>LOAD</em> referred to a <em>LOAD_DEREF</em> or a
<em>LOAD_CLOSURE</em> if you tried to include <em>LOAD_CLOSURE</em> in your
pseudo instruction.</p>
</li>
</ol>
</div>
<div class="section" id="solutions-to-practice-problems">
<h2>4.34. Solutions to Practice Problems<a class="headerlink" href="#solutions-to-practice-problems" title="Permalink to this headline">¶</a></h2>
<p>These are solutions to the practice problem s. You should only consult these answers after you have tried each of them for yourself first. Practice problems  are meant to help reinforce the material you have just read so make use of them.</p>
<div class="section" id="solution-to-practice-problem-4-1">
<span id="exercise4-1"></span><h3>4.34.1. Solution to Practice Problem 4.1<a class="headerlink" href="#solution-to-practice-problem-4-1" title="Permalink to this headline">¶</a></h3>
<p>The Java compiler insists that if the class is called <em>Test</em> then the
file must be <em>Test.java</em>. This is necessary because when class <em>A</em> is
compiled and uses the <em>Test</em> class, the Java compiler must find the
<em>Test</em> class. There is nothing included or imported into class <em>A</em> to
tell the compiler where to look. Instead, Java looks for a file called
<em>Test.java</em> if class <em>Test</em> is used in class <em>A</em>.</p>
</div>
<div class="section" id="solution-to-practice-problem-4-2">
<span id="exercise4-2"></span><h3>4.34.2. Solution to Practice Problem 4.2<a class="headerlink" href="#solution-to-practice-problem-4-2" title="Permalink to this headline">¶</a></h3>
<p>The C++ compiler uses macro processor directives to explicitly include
header files which declare classes and other entities. The header file
names are explicitly provided in the <em>include</em> macro processor
directive. The C++ compiler does not need to infer the name of the
module from the name of the class like Java does.</p>
</div>
<div class="section" id="solution-to-practice-problem-4-3">
<span id="exercise4-3"></span><h3>4.34.3. Solution to Practice Problem 4.3<a class="headerlink" href="#solution-to-practice-problem-4-3" title="Permalink to this headline">¶</a></h3>
<p>In C++ programs the name of the executable for the program is passed in
<em>argv[0]</em>. So the value of <em>argc</em> is always at least one. In a Java
program the program consists of a collection of .class files. The main
function must be defined inside the public class for one of these .class
files, so the name of the main module is always known by the programmer
and therefore is not passed as an argument.</p>
</div>
<div class="section" id="solution-to-practice-problem-4-4">
<span id="exercise4-4"></span><h3>4.34.4. Solution to Practice Problem 4.4<a class="headerlink" href="#solution-to-practice-problem-4-4" title="Permalink to this headline">¶</a></h3>
<p>Polymorphism occurs in Python because methods are looked up by name at
run-time. This leads to run-time type checking, not compile-time as is
supported by C++ and Java. C++ and Java are statically typed languages.
Python is dynamically typed. Further, Python supports inheritance, but
the purpose of inheritance in Python is only for code re-use.
Polymorphism is not related to inheritance in Python programs since
polymorphism occurs because of the late, just in time, lookup of methods
in an object’s attribute dictionary.</p>
</div>
<div class="section" id="solution-to-practice-problem-4-5">
<span id="exercise4-5"></span><h3>4.34.5. Solution to Practice Problem 4.5<a class="headerlink" href="#solution-to-practice-problem-4-5" title="Permalink to this headline">¶</a></h3>
<p>The confusion may occur when an <em>ArrayList</em> of <em>Integer</em> was declared.
When calling <em>a.remove(1)</em> will autoboxing occur? The answer is no, in
this case because the <em>ArrayList</em> class contains a method with <em>int</em> as
a parameter Java will choose the method with the closest argument types
when there are multiple to choose from. Nevertheless, the programmer
must be aware of this to correctly choose the right <em>remove</em> method. If
the <em>Object</em> argument version is really the one to call, then it must
called as <em>a.remove(new Integer(1))</em> to get the correct <em>remove</em> called.
Boxing must be explicitly called in this case. No autoboxing will occur.</p>
</div>
<div class="section" id="solution-to-practice-problem-4-6">
<span id="exercise4-6"></span><h3>4.34.6. Solution to Practice Problem 4.6<a class="headerlink" href="#solution-to-practice-problem-4-6" title="Permalink to this headline">¶</a></h3>
<p>It’s the LOAD_BUILD_CLASS instruction. This instruction loads the
built-in function onto the operand stack so it can be called to
dynamically build a class.</p>
</div>
<div class="section" id="solution-to-practice-problem-4-7">
<span id="exercise4-7"></span><h3>4.34.7. Solution to Practice Problem 4.7<a class="headerlink" href="#solution-to-practice-problem-4-7" title="Permalink to this headline">¶</a></h3>
<p>The bound variables are <em>f</em>, <em>x</em>, and <em>y</em>. They are bound because the
name of the function is always defined and the parameter name is given
the value of any argument passed to the function. The variable <em>y</em> is
bound to the same value as <em>x</em> because <em>y</em> appears on the left side of
an assignment statement.</p>
<p>The free variables are <em>aVal</em> and <em>lstInts</em>. These values have to be
supplied in the environment by forming a closure before the function can
be executed.</p>
</div>
<div class="section" id="solution-to-practice-problem-4-8">
<span id="exercise4-8"></span><h3>4.34.8. Solution to Practice Problem 4.8<a class="headerlink" href="#solution-to-practice-problem-4-8" title="Permalink to this headline">¶</a></h3>
<p>The __init__ gets called during object instantiation on line 52 of
figure&nbsp;[pyclassinit].</p>
</div>
<div class="section" id="solution-to-practice-problem-4-9">
<span id="exercise4-9"></span><h3>4.34.9. Solution to Practice Problem 4.9<a class="headerlink" href="#solution-to-practice-problem-4-9" title="Permalink to this headline">¶</a></h3>
<p>Since magic methods are looked up at run-time (i.e. dynamically) then at
any time before the magic method, the object can have its magic method
implementation replaced by an alternative implementation. There is no
modification necessary to the JCoCo Java code.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="functional.html" title="5. Standard ML"
             >next</a> |</li>
        <li class="right" >
          <a href="assembly.html" title="3. Assembly Language"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Foundations of Programming Languages Second Edition</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Kent D. Lee.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>